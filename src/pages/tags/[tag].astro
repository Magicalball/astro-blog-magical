---
import BaseLayout from '../../layouts/BaseLayout.astro'
import VirtualBlogList from '../../components/VirtualBlogList.tsx'
import { normalizePost } from '../../utils/getPosts'

export async function getStaticPaths() {
  const globResult = import.meta.glob('../posts/*.{md,mdx}');
  const allPost: any[] = await Promise.all(Object.values(globResult).map(fn => fn()));

  const uniqueTags: string[] = [
    ...new Set(allPost.flatMap((post: any) => post.frontmatter.tags.flat())),
  ]

  return uniqueTags.map((tag: string) => {
    const filteredPosts = allPost.filter((post: any) =>
      post.frontmatter.tags.includes(tag),
    )
    return {
      params: { tag },
      props: { posts: filteredPosts },
    }
  })
}

const { tag } = Astro.params
const { posts } = Astro.props

// 为虚拟滚动准备标准化的文章数据
const virtualScrollPosts = posts.map(normalizePost)
---

<BaseLayout pageTitle={tag}>
  <p>包含「{tag}」标签的文章</p>
  
  <VirtualBlogList 
    posts={virtualScrollPosts} 
    client:load 
  />
</BaseLayout>
