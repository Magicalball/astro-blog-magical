---
import BaseLayout from '../../layouts/BaseLayout.astro'
import VirtualBlogList from '../../components/VirtualBlogList.tsx'
import { normalizePost } from '../../utils/getPosts'
import { getComparableUtcTime } from '../../utils/validation'

export async function getStaticPaths() {
  const globResult = import.meta.glob('../posts/**/*.{md,mdx}');
  const allPostRaw: any[] = await Promise.all(Object.values(globResult).map(fn => fn()));
  const allPost = allPostRaw.map((p: any) => normalizePost(p));

  const uniqueTags: string[] = [
    ...new Set(allPost.flatMap((post: any) => (post.tags || []).flat())),
  ]

  return uniqueTags.map((tag: string) => {
    const filteredPosts = allPost
      .filter((post: any) => (post.tags || []).includes(tag))
      .slice()
      .sort((a: any, b: any) => getComparableUtcTime(b.pubDate) - getComparableUtcTime(a.pubDate))
    return {
      params: { tag },
      props: { posts: filteredPosts },
    }
  })
}

const { tag } = Astro.params
const { posts } = Astro.props
const virtualScrollPosts = posts
---

<BaseLayout pageTitle={tag}>
  <p>包含「{tag}」标签的文章</p>
  
  <VirtualBlogList 
    posts={virtualScrollPosts} 
    client:load 
  />
</BaseLayout>
